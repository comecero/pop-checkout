/*
Comecero Popup Cart version: ï»¿1.1.0
https://comecero.com
https://github.com/comecero/cart
Copyright Comecero and other contributors. Released under MIT license. See LICENSE for details.
*/

app.directive("ccExpDate",function(){return{restrict:"A",scope:{date:"=?",expMonth:"=?",expYear:"=?"},link:function(e,t,a){var n=!1;document.addEventListener("keydown",function(e){n=8==e.which||46==e.which}),e.$watch("date",function(t,a){if(t!=a){if(!t)return void(e.date=null);if("1/"==t)return void(e.date="01 / ");if(n)return" /"==utils.right(t,2)?void(e.date=utils.left(t,t.length-2)):void(e.date=t);var o="";t&&(o=t.replace(/[^0-9]/g,"")),1==o.length&&/[2-9]/.test(o)&&(o="0".concat(o)),2==o.length&&/[3-9]/.test(utils.right(o,1))&&(o+=" / "),o.length>=2&&"/ "!=utils.right(o,2)&&(o=o.substring(0,2)+" / "+utils.right(o,o.length-2)),o.length>=9&&(o=utils.left(o,9)),e.date=o,o.length>=2&&(e.expMonth=o.substring(0,2)),o.length>=7&&(e.expYear=utils.right(o,2))}})}}}),app.directive("postalCodePlaceholder",["gettextCatalog",function(e){return{restrict:"A",scope:{postalCodePlaceholder:"=?",country:"=?"},link:function(t,a,n){t.$watch("country",function(a,n){"US"==a?t.postalCodePlaceholder="ZIP":t.postalCodePlaceholder=e.getString("Postal Code")})}}}]),app.directive("downloadReceipt",["ApiService",function(e){return{restrict:"A",scope:{orderId:"=?",orderUrl:"=?",error:"=?"},link:function(t,a,n){a.bind("click",function(){e.getItemPdf(t.orderUrl).then(function(e){var a=new Blob([e.data],{type:"application/pdf"});saveAs(a,"Order_"+t.orderId+".pdf")},function(e){t.error=e})})}}}]),app.directive("insertHtml",function(){return{restrict:"AE",link:function(e,t,a){},templateUrl:function(e,t){return t.insertHtml}}}),app.controller("IndexController",["$scope","ApiService","SettingsService",function(e,t,a){window.location="getting-started"}]),app.controller("CheckoutController",["$scope","CartService","OrderService","GeoService","CurrencyService","SettingsService","HelperService","PaymentService","LanguageService","StorageService","$uibModal","$timeout","gettextCatalog","$location","$document","$routeParams",function(e,t,a,n,o,i,r,d,s,c,p,l,m,u,g,h){function f(a){a&&a.customer&&a.customer.email&&!utils.isValidEmail(a.customer.email)&&delete a.customer.email,e.data.input=angular.copy(a),t.update(a,e.data.params,!0).then(function(t){e.data.cart=t,e.hideSpinner(),w(k),e.settings.app.use_product_icon&&t.items[0].product.images[0]&&(e.data.header_image=t.items[0].product.images[0].link_square),sendMessage({type:"on_load",cart:t},e.settings.app.allowed_origin_hosts),0==t.options.payment_methods.length&&(e.data.error={message:"No payment methods are available for the selected currency."})},function(t){return t.code&&"invalid_promotion_code"==t.code?(delete a.promotion_code,void f(a)):(e.data.error=t,e.hideSpinner(),void w(k))})}function w(t){function a(){l(function(){e.selectNewPaymentMethod(!0),e.data.error=null},500)}e.options.showForm=!0,t&&(e.modalInstance=p.open({templateUrl:"app/pages/simple/checkout.html",backdrop:!1,keyboard:!1,scope:e}),e.modalInstance.result.then(function(){a()},function(){a()}),window.__pageview&&window.__pageview.recordPageLoad&&window.__pageview.recordPageLoad())}function y(e){var t=e.language;t&&s.setLanguage(t)}function v(e){if(e){var t=document.getElementsByClassName("modal");t&&t.length&&(t[0].scrollTop=0)}else g.scrollTop(0,500)}function S(){amazonPay.logout()}function P(t,n){if(0!=i.get().app.show_digital_delivery&&null!=e.data.payment.order){if(n=n||0,_.where(e.data.payment.order.items,{license_pending:!0}).length>0?e.data.awaitingLicense=!0:e.data.awaitingLicense=!1,0==e.data.awaitingLicense||n>3)return void e.$apply(function(){e.data.awaitingLicense=!1});var o={show:"items.item_id,items.license.*",expand:"items.license"};a.get(t,o).then(function(a){return _.each(a.items,function(t){t.license&&(_.find(e.data.payment.order.items,function(e){return e.item_id==t.item_id}).license=t.license)}),0==_.where(e.data.payment.order.items,{type:"digital",license:null}).length?void(e.data.awaitingLicense=!1):(n++,void setTimeout(function(){P(t,n)},3500))})}}function b(e){return e&&0!=e.length&&e[0].payment_method_type?null!=_.findWhere(e,{payment_method_type:"credit_card"})?"credit_card":null!=_.findWhere(e,{payment_method_type:"paypal"})?"paypal":null!=_.findWhere(e,{payment_method_type:"amazon_pay"})?"amazon_pay":e[0].payment_method_type:null}var k=e.$resolve.asModal;e.data={},e.data.showSection="payment",e.geoService=n,e.settings=i.get(),e.helpers=r,e.options={showSpinner:!1,showForm:!1,payment_method:"credit_card"},e.paymentParams={expand:"payment_method.data,order.customer,order.items.product.images,order.items.subscription_terms,cart.options,cart.items.subscription_terms,cart.items.product.images"},1==i.get().app.show_digital_delivery&&(e.paymentParams.expand+=",order.items.download,order.items.license"),e.data.params={},e.data.params.expand="items.product,items.subscription_terms,customer.payment_methods,options",e.data.params.hide="items.product.formatted,items.product.prices,items.product.url,items.product.description,items.product.images.link_small,items.product.images.link_medium,items.product.images.link_large,items.product.images.link,items.product.images.filename,items.product.images.formatted,items.product.images.url,items.product.images.date_created,items.product.images.date_modified",e.data.payment_method={},e.data.header_image=e.settings.app.logo_popup_square||"images/default_popup_icon.png",e.data.order=null,e.data.card={type:"credit_card"},e.data.amazon_pay={type:"amazon_pay"},e.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/simple/review/{{payment_id}}",cancel_url:i.get().app.main_shopping_url||localStorage.getItem("parent_url")||window.location.href}},e.showSpinner=function(t){t||(t=0),e.options.showForm=!1,e.spinnerTimeout=l(function(){e.options.showSpinner=!0},t)},e.hideSpinner=function(){e.options.showForm=!0,e.options.showSpinner=!1,e.spinnerTimeout&&l.cancel(e.spinnerTimeout)},y(u.search());var x=h.id;if(x)d.get(x,e.paymentParams).then(function(t){e.data.payment=t,e.data.cart=t.cart,e.settings.app.use_product_icon&&t.cart.items[0].product.images[0]&&(e.data.header_image=t.cart.items[0].product.images[0].link_square),"completed"==t.status||"pending"==t.status?e.data.showSection="receipt":e.data.showSection="review",w(k)},function(t){e.data.error=t,w(k)});else{var C=u.search().cart;C?(C=JSON.parse(C),u.search("cart",null)):C=t.fromParams({},u),k||(e.showSpinner(350),f(C))}e.onPaymentSuccess=function(t){if(e.data.payment=t,e.data.cart=t.cart,"completed"==t.status||"pending"==t.status)e.data.showSection="receipt",v(k),e.settings.app.keep_wallet_session||S(),window.__conversion&&window.__conversion.recordConversion&&window.__conversion.recordConversion(t.order.order_id),setTimeout(function(){P(t.order.order_id)},1e3);else switch(t.payment_method.type){case"paypal":e.redirect(t.response_data.redirect_url);break;case"amazon_pay":e.data.showSection="review"}},e.close=function(){if(window.onbeforeunload=null,!e.data.payment||"completed"!=e.data.payment.status&&"pending"!=e.data.payment.status||(e.data.payment=null,c.remove("cart_id")),sendMessage({type:"close",cart:e.data.cart,order:e.data.order},e.settings.app.allowed_origin_hosts),e.modalInstance)e.modalInstance.close();else if(null!=window.opener)window.close();else{var t=localStorage.getItem("parent_url")||i.get().app.main_shopping_url;window.location.href=t}},e.setPaymentMethod=function(t){e.options.payment_method=t},e.selectNewPaymentMethod=function(t){if(delete e.data.error,delete e.data.amazon_pay.data,e.data.card={type:"credit_card"},e.data.exp=null,e.options.payment_method="credit_card",t||S(),x){var a=u.path().substring(1);a="/"+a.substring(0,a.indexOf("/")),u.path(a)}else e.data.showSection="payment"},window.onbeforeunload=function(){e.close()},e.redirect=function(t){e.showSpinner(),window.onbeforeunload=null,k?sendMessage({type:"redirect",url:t},e.settings.app.allowed_origin_hosts):window.location=t},e.downloadReceipt=function(){ApiService.getItemPdf(e.data.payment.order.url).then(function(t){var a=new Blob([t.data],{type:"application/pdf"});saveAs(a,"Order_"+e.data.payment.order.order_id+".pdf")},function(t){e.exception.error=t})},e.showPaymentSelections=function(){return!(e.data&&e.data.amazon_pay&&e.data.amazon_pay.data)&&(!(e.settings&&e.settings.account.payment_method_types.length<2)&&!(e.data&&e.data.cart&&e.data.cart.options.payment_methods.length<2))},e.showCurrencies=function(){return"payment"==e.data.showSection&&!e.data.amazon_pay.data},e.$watch("data.cart.options.payment_methods",function(t,a){t&&t!=a&&(e.options.payment_method=b(t))},!0),e.$watch("data.error",function(t,a){e.data.error&&v(k)}),e.$on("messageReceived",function(t,a){"add_to_cart"==a.type&&a.cart&&(e.showSpinner(350),f(JSON.parse(a.cart)))})}]);